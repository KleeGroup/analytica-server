<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<script type="text/javascript" src="http://d3js.org/d3.v3.js"></script>
				<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">

		
		<style type="text/css">
		.span3{
            	border-style: solid;
            	
            }

            svg{
            	border-style: solid;
            	display:block;
  				margin:auto;
            	color:red;
            }

			.background {
				stroke: #808080;
				stroke-width: 1;
				fill: none;
			}

			.area{
				fill: #ADD8E6;                  
    			stroke-width: 0px;     
			}

			.axis path, .axis line {
			  fill: none;
			  stroke: #000;
			  shape-rendering: crispEdges;
			}

			.metrics-container {
	width: auto;
	height: auto;
	padding: 10px 10px 10px 10px;
	border-style: solid;
	border-width: 1px;
	float: left;
	margin-left: 20px;
	margin-top: 20px;
}

body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: auto;
  position: relative;
  width: 960px;
}

text {
  font: 10px sans-serif;
}

form {
  position: absolute;
  right: 10px;
  top: 10px;
}

			
		</style>			

	</head>

	<body>

 		<div id ="box6" class = "span3"></div>
 		
 	

			<script type="text/javascript">
				var drawPieChart = function(data,id){
				
					var w = 270;
					var h = 200;
					var r = 100;
					var ir = 50;
					var textOffset = 24;
					var tweenDuration = 1050;

					//OBJECTS TO BE POPULATED WITH DATA LATER
					var lines, valueLabels, nameLabels;
					var pieData = [];
					var filteredPieData = [];

					//D3 helper function to populate pie slice parameters from array data
					var donut = d3.layout.pie().value(function(d) {
						return d.itemValue;
					}).sort(null);

					//D3 helper function to create colors from an ordinal scale
					var color = d3.scale.category20c();

					//D3 helper function to draw arcs, populates parameter "d" in path object
					var arc = d3.svg.arc()
						.startAngle(function(d) {
						return d.startAngle;
					})
						.endAngle(function(d) {
						return d.endAngle;
					})
						.innerRadius(ir)
						.outerRadius(r);

					///////////////////////////////////////////////////////////
					// CREATE VIS & GROUPS ////////////////////////////////////
					///////////////////////////////////////////////////////////

					var vis = d3.select("#"+id).append("svg:svg")
						.attr("width", w)
						.attr("height", h);

					//GROUP FOR ARCS/PATHS
					var arc_group = vis.append("svg:g")
						.attr("class", "arc")
						.attr("transform", "translate(" + (w / 2) + "," + (h / 2) + ")");

					//GROUP FOR LABELS
					var label_group = vis.append("svg:g")
						.attr("class", "label_group")
						.attr("transform", "translate(" + (w / 2) + "," + (h / 2) + ")");

					//GROUP FOR CENTER TEXT  
					var center_group = vis.append("svg:g")
						.attr("class", "center_group")
						.attr("transform", "translate(" + (w / 2) + "," + (h / 2) + ")");

					//PLACEHOLDER GRAY CIRCLE
					// var paths = arc_group.append("svg:circle")
					//     .attr("fill", "#EFEFEF")
					//     .attr("r", r);

					///////////////////////////////////////////////////////////
					// CENTER TEXT ////////////////////////////////////////////
					///////////////////////////////////////////////////////////

					//WHITE CIRCLE BEHIND LABELS
					var whiteCircle = center_group.append("svg:circle")
					  .attr("fill", "white")
					  .attr("r", ir);

					// "TOTAL" LABEL
					var totalLabel = center_group.append("svg:text")
					  .attr("class", "label")
					  .attr("dy", -15)
					  .attr("text-anchor", "middle") // text-align: right
					  .text("TOTAL");

					//TOTAL TRAFFIC VALUE
					var totalValue = center_group.append("svg:text")
					  .attr("class", "total")
					  .attr("dy", 7)
					  .attr("text-anchor", "middle") // text-align: right
					  .text(".......");

					//UNITS LABEL
					var totalUnits = center_group.append("svg:text")
					  .attr("class", "units")
					  .attr("dy", 21)
					  .attr("text-anchor", "middle") // text-align: right
					  .text("unit");

					///////////////////////////////////////////////////////////
					// STREAKER CONNECTION ////////////////////////////////////
					///////////////////////////////////////////////////////////

					// to draw the chart

					function draw() {

						pieData = donut(data);

						var sliceProportion = 0; //size of this slice
						filteredPieData = pieData.filter(filterData);
 						var totalOctets = 14524;
						function filterData(element, index, array) {
							element.name = data[index].itemLabel;
							element.value = data[index].itemValue;
							element.color = data[index].itemColor;
							sliceProportion += element.value;
							return (element.value > 0);
						}


						 //REMOVE PLACEHOLDER CIRCLE

					    totalValue.text(function(){
					      return  totalOctets; // Ã  recalculer
					    });


						//DRAW ARC PATHS
						paths = arc_group.selectAll("path").data(filteredPieData);
						paths.enter().append("svg:path")
							.attr("stroke", "white")
							.attr("stroke-width", 0.5)
							.attr("fill", function(d, i) {
								console.log(d);
								if (d.color ===undefined) {
									return color(i);
								}
							return d.color;
						})
							.transition()
							.duration(tweenDuration)
							.attrTween("d", pieTween);


					 //DRAW TICK MARK LINES FOR LABELS
    lines = label_group.selectAll("line").data(filteredPieData);
    lines.enter().append("svg:line")
      .attr("x1", 0)
      .attr("x2", 0)
      .attr("y1", -r-3)
      .attr("y2", -r-8)
      .attr("stroke", "gray")
      .attr("transform", function(d) {
        return "rotate(" + (d.startAngle+d.endAngle)/2 * (180/Math.PI) + ")";
      });
    lines.transition()
      .duration(tweenDuration)
      .attr("transform", function(d) {
        return "rotate(" + (d.startAngle+d.endAngle)/2 * (180/Math.PI) + ")";
      });
    lines.exit().remove();

    //DRAW LABELS WITH PERCENTAGE VALUES
    valueLabels = label_group.selectAll("text.value").data(filteredPieData)
      .attr("dy", function(d){
        if ((d.startAngle+d.endAngle)/2 > Math.PI/2 && (d.startAngle+d.endAngle)/2 < Math.PI*1.5 ) {
          return 5;
        } else {
          return -7;
        }
      })
      .attr("text-anchor", function(d){
        if ( (d.startAngle+d.endAngle)/2 < Math.PI ){
          return "beginning";
        } else {
          return "end";
        }
      })
      .text(function(d){
        var percentage = (d.value/totalOctets)*100;
        return percentage.toFixed(1) + "%";
      });

    valueLabels.enter().append("svg:text")
      .attr("class", "value")
      .attr("transform", function(d) {
        return "translate(" + Math.cos(((d.startAngle+d.endAngle - Math.PI)/2)) * (r+textOffset) + "," + Math.sin((d.startAngle+d.endAngle - Math.PI)/2) * (r+textOffset) + ")";
      })
      .attr("dy", function(d){
        if ((d.startAngle+d.endAngle)/2 > Math.PI/2 && (d.startAngle+d.endAngle)/2 < Math.PI*1.5 ) {
          return 5;
        } else {
          return -7;
        }
      })
      .attr("text-anchor", function(d){
        if ( (d.startAngle+d.endAngle)/2 < Math.PI ){
          return "beginning";
        } else {
          return "end";
        }
      }).text(function(d){
        var percentage = (d.value/totalOctets)*100;
        return percentage.toFixed(1) + "%";
      });

    valueLabels.transition().duration(tweenDuration).attrTween("transform", textTween);

    valueLabels.exit().remove();


    //DRAW LABELS WITH ENTITY NAMES
    nameLabels = label_group.selectAll("text.units").data(filteredPieData)
      .attr("dy", function(d){
        if ((d.startAngle+d.endAngle)/2 > Math.PI/2 && (d.startAngle+d.endAngle)/2 < Math.PI*1.5 ) {
          return 17;
        } else {
          return 5;
        }
      })
      .attr("text-anchor", function(d){
        if ((d.startAngle+d.endAngle)/2 < Math.PI ) {
          return "beginning";
        } else {
          return "end";
        }
      }).text(function(d){
        return d.name;
      });

    nameLabels.enter().append("svg:text")
      .attr("class", "units")
      .attr("transform", function(d) {
        return "translate(" + Math.cos(((d.startAngle+d.endAngle - Math.PI)/2)) * (r+textOffset) + "," + Math.sin((d.startAngle+d.endAngle - Math.PI)/2) * (r+textOffset) + ")";
      })
      .attr("dy", function(d){
        if ((d.startAngle+d.endAngle)/2 > Math.PI/2 && (d.startAngle+d.endAngle)/2 < Math.PI*1.5 ) {
          return 17;
        } else {
          return 5;
        }
      })
      .attr("text-anchor", function(d){
        if ((d.startAngle+d.endAngle)/2 < Math.PI ) {
          return "beginning";
        } else {
          return "end";
        }
      }).text(function(d){
        return d.name;
      });

    nameLabels.transition().duration(tweenDuration).attrTween("transform", textTween);

    nameLabels.exit().remove();
  
}

					///////////////////////////////////////////////////////////
					// FUNCTIONS //////////////////////////////////////////////
					///////////////////////////////////////////////////////////

					// Interpolate the arcs in data space.

					function pieTween(d, i) {
						var s0 = 0;
						var e0 = 0;
						var i = d3.interpolate({
							startAngle: s0,
							endAngle: e0
						}, {
							startAngle: d.startAngle,
							endAngle: d.endAngle
						});
						return function(t) {
							var b = i(t);
							return arc(b);
						};
					}

					function textTween(d, i) {
					  var a = 0;
					  
					  var b = (d.startAngle + d.endAngle - Math.PI)/2;

					  var fn = d3.interpolateNumber(a, b);
					  return function(t) {
					    var val = fn(t);
					    return "translate(" + Math.cos(val) * (r+textOffset) + "," + Math.sin(val) * (r+textOffset) + ")";
					  };
					}



					draw();
				}
			</script>
			<script type="text/javascript">

				///////////////////////////////////////////////////////////
					// GENERATE FAKE DATA /////////////////////////////////////
					///////////////////////////////////////////////////////////

					var data = [{
							"itemLabel": "Social Media",
							"itemValue": 90,
						}, {
							"itemLabel": "Blogs",
							"itemValue": 30,
						}, {
							"itemLabel": "Text Messaging",
							"itemValue": 60,
						}, {
							"itemLabel": "Email",
							"itemValue": 90,
							
						},
					];


					/*var data = [{"label":"PAGE/Artist", "value":80}, 
						          {"label":"PAGE/Search", "value":10}, 
						          {"label":"PAGE/Home", "value":30}];*/
					drawPieChart(data,"box6");

					

			</script>

	</body>
</html>