<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<script type="text/javascript" src="http://d3js.org/d3.v3.js"></script>
		<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">
		<style type="text/css">

			.axis path,
			.axis line {
			    fill: none;
			    stroke: grey;
			    stroke-width: 1;
			    shape-rendering: crispEdges;
			    
			}
			.axis text{
				font-size: 10px;				
			}

			.line {
				 fill: none;
				 stroke: #FF4444;
				 stroke-width: 1.5px;
			}

			.tooltip {
			position: absolute;
			text-align: center;
			width: 60px;
			height: 25px;
			font: 9px Helvetica,sans-serif;
			background: #FFF;
			border: 0px;
			border-radius: 6px;
			box-shadow: 0px 1px 1px rgba(0, 0, 0, 0.6);
			pointer-events: none;
			text-shadow: 0px 1px 0px #ccc;
			}
			.legend {
	            padding: 5px;
	            font: 10px sans-serif;
	            background: yellow;
	            box-shadow: 2px 2px 1px #888;
            }

            .span6{
            	border-style: solid;
            	
            }
            svg{
            	border-style: solid;
            	display:block;
  				margin:auto;
            	color:red;
            }

		</style>
	</head>

	<body class ="container">
		<div></div>
 		<div id = "box5" class ="span6">
 		</div>
 		<!--Script for line sparklines-->
 		<!--Script for bar and line chart-->
		<script type="text/javascript">
			var linePlusBarChart = function(datas,id){

			  //Public Variables with default settings
			  var margin = {top: 20, right: 30, bottom: 50, left: 30}
			      , width = null // width - margin.left - margin.right
			      , height = null // height -margin.top - margin.bottom
			      , getX = function(d) { return d.x }
			      , getY = function(d) { return d.y }
			      , color = null
			      , tooltip = function(key, x, y, e, graph) {
			          return '<h3>' + key + '</h3>' +
			                 '<p>' +  y + ' at ' + x + '</p>';
			        }
			      , x
			      , y1
			      , y2
			      ,barWidth=20,
			      space = 5;

			    var xAxis,
			      yRightAxis,
			      yLeftAxis,
			      line,
			      bars,
			      legend;

			    var defaultColors = ["#33B5E5","#FF4444"];
			      //-------------------------------------------------------

			      if(datas[0].color ===undefined){
			      	datas[0].color = defaultColors[0];
			      }
			      if(datas[1].color ===undefined){
			      	datas[1].color = defaultColors[1];
			      }
				  var container = document.getElementById(id);
			      height = 155;
			      width = 900; // span6
			      var aux = 460 - width;
			      barWidth = width/(datas[0].values).length - space;

			      x = d3.time.scale().range([0, width]);
			      yL = d3.scale.linear().range([height, 0]);
			      yR = d3.scale.linear().range([height, 0]);

			      /*var minValue =  // find min and max value of the two ranges and use them for the x domain below
			      ,maxValeu =*/

			      x.domain([new Date(d3.min(datas[1].values, function(d) {  
                      return d[0];
                    })-3600000),d3.time.hour.offset(new Date(d3.max(datas[1].values, function(d) {
                      return d[0];
                    })+3600000),0)]);

			      var delta  = 5/Math.min(d3.max(datas[0].values, function(d) {
			          return d[1];
			        }),d3.max(datas[1].values, function(d) {
			          return d[1];
			        }));
			     // alert(delta);
			     yLMax = d3.max(datas[0].values, function(d) {
			          return d[1];
			        });
			     yRMax = d3.max(datas[1].values, function(d) {
			          return d[1];
			        });

			      yL.domain([0, yLMax]);
			      yR.domain([0, yRMax]);

			     
			      xAxis = d3.svg.axis().scale(x).orient("bottom").tickFormat(d3.time.format.utc("%d/%m-%H:%M")).ticks(d3.time.hours, 5);
			      yRightAxis = d3.svg.axis().scale(yR).orient("right").ticks(4);
			      yLeftAxis = d3.svg.axis().scale(yL).orient("left").ticks(4);

			      line = d3.svg.line().x(function(d){return x(d[0]);}).y(function(d){return yR(d[1])}).interpolate(interpolateSankey);

			      var div = d3.select("#"+id).append("div")
				    .attr("class", "tooltip")
					.style("opacity", 1e-6);
					//div.fadeIn(200);

				  var parseToDate = function(d){
				  		var format = d3.time.format.utc("%d/%m-%H:%M");
						
				  		return format(new Date(d[0]));
				  };

				   var parseToDate = function(d){
				  		var format = d3.time.format.utc("%d/%m-%H:%M");
						
				  		return format(new Date(d[0]));
				  };
				  
				  var getTextY = function(d){
				  	if((d===undefined)||((d.key === undefined)&&(d.unit===undefined))){
				  		throw "Labels and units not defined" ;
				  	}
				  	var text="";
				  	if(d.key===undefined){
				  		text += d.unit;
				  	}
				  	else if(d.unit === undefined){
				  		text+=d.key;
				  	}
				  	else {
				  		text = d.key+" ( "+d.unit+" )";
				  	}

				  	return text;

				  }

			      var chart = d3.select('#'+id)
			        .append("svg")
			        .attr("width", width + margin.left + margin.right)
			        .attr("height", height + margin.top + margin.bottom)
			        .append("g")
			        .attr("transform", "translate(" +margin.left+ "," + margin.top + ")");

			        /*chart.append("path")      // Add the valueline path.
			          .attr("d", line(datas));*/

			        // Draw X-axis grid lines

					chart.selectAll("line.x")
					  .data(x.ticks(10))
					  .enter().append("line")
					  .attr("class", "x")
					  .attr("x1", x)
					  .attr("x2", x)
					  .attr("y1", 0)
					  .attr("y2", height)
					  .style("stroke", "#ccc");
					 
					// Draw Y-axis grid lines
					chart.selectAll("line.y")
					  .data(yL.ticks(10))
					  .enter().append("line")
					  .attr("class", "y")
					  .attr("x1", 0)
					  .attr("x2", width)
					  .attr("y1", yL)
					  .attr("y2", yL)
					  .style("stroke", "#ccc");

			        chart.append("g")       // Add the X Axis
			            .attr("class", "x axis")
			            .attr("transform", "translate(0," + height + ")")
			            .call(xAxis);

			        chart.append("g")         // Add the Y Axis
			            .attr("class", "y axis")
			            .call(yLeftAxis)
			            .append("text")
					    .attr("transform", "rotate(-90)")
					    .attr("y", 2)
					    .attr("dy", ".71em")
				      	.style("text-anchor", "end")
			            .text(getTextY(datas[0]))
			            ;


			        chart.append("g")             
				        .attr("class", "y axis")    
				        .attr("transform", "translate(" + width + " ,0)")   
				        .call(yRightAxis)
				        .append("text")
					    .attr("transform", "rotate(-90)")
					    .attr("y", -10)
					    .attr("dy", ".71em")
				      	.style("text-anchor", "end")
				        .text(getTextY(datas[1]));

				       var getToolTipText = function(d,datas){
				       		var text = "";
				       		if (datas.unit === undefined){
				       			text = d[1] + " " +datas.key +" Le "+parseToDate(d);
				       		}
				       		else {
				       			text = d[1] + " "+ datas.unit +" Le "+parseToDate(d);
				       		}
				       		return text;
				       }

			        bars = chart.selectAll("rect")
			          .data(datas[0].values)
			          .enter().append("rect")
			          .attr("width",barWidth)
			          .attr("height", function(d) {return height-yL(d[1]);})
			          .attr("y", function(d){return yL(d[1])})
			          .attr("x", function(d, i) {return x((new Date(d[0])))-barWidth/2;})
			          .style("fill",datas[0].color)
			          .style("stroke","white")
			          .style("stroke-width",1)
			          .on("mouseover", function(d){div.transition().duration(200).style("opacity", 1)})
					  .on("mousemove", function(d){
					  	div.text(getToolTipText(d,datas[0])).style("left", (d3.event.pageX - 34) + "px").style("top", (d3.event.pageY - 50) + "px");
					  })
					  .on("mouseout", function(d){div.transition().duration(200).style("opacity", 1e-6);});	;

			        chart.append("svg:path")
			          .datum(datas[1].values)
			          .attr("d", line)
			          .attr("class","line")
			          .style("stroke",datas[1].color);		       

var c = d3.scale.linear().domain([0,1]).range([datas[1].color, datas[1].color]).interpolate(d3.interpolateHsl);
			       chart.selectAll("circle")
					    .data(datas[1].values)
					    .enter().append("svg:circle")
					    .attr("cx", function(d) { return x(d[0]) })
					    .attr("cy", function(d) { return yR(d[1]) })
					    .attr("stroke-width", "none")
					    .attr("fill", function() { return c(Math.random()) })
					    .attr("fill-opacity", .5)
					    .attr("r", 3)
					    .style("display","inline")
					    .on("mouseover", function(d) {
					    	div.transition().duration(200).style("opacity", 1);
					        d3.select(this).transition().duration(200).attr("fill-opacity", .5)
					    })
					    .on("mousemove", function(d){div.text(getToolTipText(d,datas[1])).style("left", (d3.event.pageX - 34) + "px").style("top", (d3.event.pageY - 70) + "px");})
					    .on("mouseout",function(){
					    	div.transition().duration(200).style("opacity", 1e-6);
					    	d3.select(this).transition().duration(200)
					    	.attr("fill-opacity", .5)
					    });


				var legend = chart.append("g")
				.attr("class", "legend")
				.attr("transform", "translate(" + 0 + " ,"+ (-margin.top)+")");
				var color_hash = {  
				0 : ["Response Time", "#09C"],
				1 : ["Hits", "black"]
			 };  var val = height+3*margin.bottom/4;
				var legendHeight = margin.bottom/2;
             	var legendWidth = width/2;
             //-----------Calcul de la largeur de la légende
             	var globalLength =0;
             	var keyLength = 0;



                legend.append("rect")
                    .attr("height", legendHeight)
                    .attr("width", legendWidth)
					.attr("rx", 5)
					.attr("ry", 5)
					.attr("transform", "translate(0,"+val+")")
					.style("fill", "#EEE");

				legend.selectAll('legend')
					.data(datas)
					.enter().append("rect")
						.attr("y", height +margin.bottom/2 + margin.top)
						.attr("x", function(d, i){return i * 150;})//Doit être calculée à partir de la taille du texte
						.attr("width", legendHeight/3)
						.attr("height", legendHeight/3)
						.style("fill", function(d, i) {return datas[datas.indexOf(d)].color;});

				legend.selectAll('legend')
					.data(datas)
					.enter().append("text")
						.attr("y", height +margin.bottom/2 + margin.top+7)
						.attr("x", function(d, i){return i *150 +20;})
						.text(function(d) {return datas[datas.indexOf(d)].key;});
			}


			function interpolateSankey(points) {
			  var x0 = points[0][0], y0 = points[0][1], x1, y1, x2,
			      path = [x0, ",", y0],
			      i = 0,
			      n = points.length;
			  while (++i < n) {
			    x1 = points[i][0], y1 = points[i][1], x2 = (x0 + x1) / 2;
			    path.push("C", x2, ",", y0, " ", x2, ",", y1, " ", x1, ",", y1);
			    x0 = x1, y0 = y1;
			  }
			  return path.join("");
			}
		</script>

			<script type="text/javascript">

					var data1 = [ [ 3625200000 , 1214] , [ 3628800000 , 285] , [ 3632400000 , 455] , [ 3636000000 , 125] , [ 3639600000 , 1850] , [ 3643200000 , 789] , [ 3646800000 , 458] , [ 3650400000 , 999] , [ 3654000000 , 775] , [ 3657600000 , 328] , [ 3661200000 , 389],[3664800000,552],[3668400000,566],[3672000000,398],[3675600000,455],[3679200000,566],[3682800000,635],[3686400000,985],[3690000000,777],[3693600000,1000],[3697200000,989],[3700800000,1245],[3704400000,522],[3708000000,300]];

					var data2 = [ [ 3625200000 , 145] , [ 3628800000 , 285] , [ 3632400000 , 455] , [ 3636000000 , 15] , [ 3639600000 , 510] , [ 3643200000 , 89] , [ 3646800000 , 58] , [ 3650400000 , 99] , [ 3654000000 , 75] , [ 3657600000 , 28] , [ 3661200000 , 39],[3664800000,52],[3668400000,566],[3672000000,398],[3675600000,455],[3679200000,566],[3682800000,35],[3686400000,85],[3690000000,77],[3693600000,100],[3697200000,89],[3700800000,125],[3704400000,22],[3708000000,30]];


					var datas = [{
						unit:"ms",
						key:"response Time",
						values:data1
					},{
						key:"Hits",
						values:data2
					}]

					linePlusBarChart(datas,"box5");
			</script>


		

	</body>
</html>